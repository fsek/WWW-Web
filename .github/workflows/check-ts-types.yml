name: Typechecking typescript

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]


jobs:
  test_ts-types:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Checkout API repo
        uses: actions/checkout@v6
        with:
          repository: fsek/WebWebWeb 
          ref: main
          path: api-repo

      - name: Build & enter DevContainer
        uses: devcontainers/ci@v0.3
        with:
          checkoutPath: api-repo           
          subFolder: . 
          runCmd: |

            sudo apt-get install -y curl

            source .venv/bin/activate

            nohup uvicorn main:app --host 0.0.0.0 --port 8000 \
              > uvicorn.log 2>&1 & disown
            # Wait for the API to be ready

            until curl --silent --fail http://localhost:8000/openapi.json; do
              sleep 1
            done

            curl --silent http://localhost:8000/openapi.json \
              > openapi.json

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Load cache
        uses: actions/cache@v4
        with:
            # See here for caching with `yarn`, `bun` or other package managers https://github.com/actions/cache/blob/main/examples.md or you can leverage caching with actions/setup-node https://github.com/actions/setup-node
          path: |
            ~/.bun/install/cache
            ~/.bun/bin
            node_modules
            ${{ github.workspace }}/.next/cache
          # Generate a new cache whenever packages or source files change.
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          # If source files changed but packages didn't, rebuild from a prior cache.
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-
      - name: Install dependencies (host)
        run: bun install --frozen-lockfile

      - name: Generate API client
        run: bun run generate-api ./api-repo/openapi.json

      - name: Check types
        run: bun run build
